# Visit our schema definition for additional information on this file format
# https://github.com/newrelic/open-install-library/blob/main/docs/recipe-spec/recipe-spec.md#schema-definition

name: php-agent-installer
displayName: PHP Agent Installer
description: New Relic install recipe for the PHP agent
repository: https://github.com/newrelic/newrelic-php-agent

installTargets:
  - type: host
    os: linux

keywords:
  - PHP

processMatch:
  - /php-fpm/

install:
  version: "3"
  silent: true

  env:
    NEW_RELIC_DISTRIBUTED_TRACING_ENABLED: true

  tasks:
    default:
      cmds:
        - task: install_packages
        - task: config_newrelic_ini
        - task: finalize_agent_config
        - task: restart_services

    install_packages:
      cmds:
        - echo "Install php-agent packages"
        - |
          if [ ! -f /etc/apt/sources.list.d/newrelic.list ]; then
            curl https://download.newrelic.com/548C16BF.gpg | sudo apt-key add -
            echo "deb http://nr-downloads-private.s3-website-us-east-1.amazonaws.com/75ac22b116/debian newrelic-testing non-free" > /etc/apt/sources.list.d/newrelic.list
          fi
          DEBIAN_FRONTEND=noninteractive sudo apt update
          DEBIAN_FRONTEND=noninteractive apt -y install newrelic-php5
      silent: true

    config_newrelic_ini:
      cmds:
        - echo "TODO: configure newrelic.ini"
        - exit 1
      silent: true

    finalize_agent_config:
      cmds:
        - echo "TODO: finalize agent config"
      silent: true

    restart_services:
      cmds:
        - echo "TODO: restart services"
      silent: true
